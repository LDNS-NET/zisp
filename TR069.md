TR-069 IMPLEMENTATION PLAN
==========================

OBJECTIVE:
Implement full TR-069 (CWMP) support in our ISP management system so we can remotely configure routers (MikroTik, TP-Link, Huawei, ZTE, etc.), auto-provision subscribers, monitor device health, and push configuration changes from our Laravel + Inertia + Vue multi-tenant system.

--------------------------------------------------------------------
1. OVERALL ARCHITECTURE
--------------------------------------------------------------------
We will use this architecture:

CPE Router (TR-069 Client) 
    → GenieACS (ACS Server)
        → Our Laravel System (via GenieACS API)
            → Tenants, Subscribers, Device Settings UI

We NEVER build TR-069 ourselves. We integrate GenieACS.

--------------------------------------------------------------------
2. SETUP GENIEACS (ACS SERVER)
--------------------------------------------------------------------
Install GenieACS on a separate server or VM.

Requirements:
- Ubuntu 22.04 or 24.04
- MongoDB
- Redis
- Node.js (LTS)

Services to run:
- genieacs-cwmp (port 7547)
- genieacs-nbi (API port)
- genieacs-fs (firmware server)

Configure:
- Set CWMP endpoint: http://your-acs-domain:7547
- Enable NBI API
- Set allowed origins for our Laravel domain

Confirm GenieACS dashboard works.

--------------------------------------------------------------------
3. CONNECT ROUTERS TO GENIEACS
--------------------------------------------------------------------
For MikroTik:
- Navigate to System → TR-069 client
- Set ACS URL to: http://your-acs-domain:7547
- Enable TR-069 service
- Add ACS username/password
- Set interval: 300 seconds (5 minutes)

For other routers:
- Enable TR-069/CWMP
- Add ACS URL
- Add ACS credentials

Verify routers appear in GenieACS interface.

--------------------------------------------------------------------
4. DEFINE DEVICE PARAMETERS TO COLLECT
--------------------------------------------------------------------
Ensure GenieACS collects and exposes the following parameters:

IDENTITY
- SerialNumber
- Manufacturer
- ModelName
- SoftwareVersion
- MAC address

DEVICE STATUS
- Uptime
- Online/offline status
- CPU load
- Memory load
- Signal strength (wireless CPE)
- LAN/WAN IP addresses

CONFIGURATION
- WiFi SSID
- WiFi Password
- PPPoE Username/Password
- WAN configuration
- Firmware version

--------------------------------------------------------------------
5. CREATE PROVISIONING RULES IN GENIEACS
--------------------------------------------------------------------
Write provisioning scripts for:

1. Assigning default config when router first connects:
    - Set PPPoE username/password from our system
    - Set WiFi SSID and Password
    - Set bandwidth/queues if supported

2. Auto-update router configuration if tenant changes:
    - WiFi name/password
    - PPPoE credentials
    - Firmware version

3. Periodic reports:
    - CPU, RAM, traffic statistics
    - Online/offline events

--------------------------------------------------------------------
6. LARAVEL BACKEND INTEGRATION (API)
--------------------------------------------------------------------
Create a new module:
App/Http/Controllers/Tenants/TenantDeviceController.php

Responsibilities:
- Fetch device list from GenieACS API
- Assign devices to subscribers (NetworkUser)
- Fetch device info (WAN IP, LAN IP, uptime, CPU, etc.)
- Trigger actions:
    - Reboot
    - Factory reset
    - Firmware update
    - Change WiFi password
    - Change SSID
    - Change PPPoE credentials
- Store device history logs
- Cache device stats locally

Create models:
- TenantDevice
- TenantDeviceLog
- TenantDeviceActionQueue

Add routes under:
routes/tenants/devices.php

--------------------------------------------------------------------
7. DATABASE STRUCTURE
--------------------------------------------------------------------
Tables needed:

tenant_devices:
- id
- tenant_id
- subscriber_id (link to NetworkUser id)
- serial_number
- model
- manufacturer
- firmware
- mac_address
- wan_ip
- lan_ip
- online (boolean)
- last_contact_at
- created_at
- updated_at

tenant_device_logs:
- id
- tenant_device_id
- log_type (info/error/warning)
- message
- raw_payload (JSON)
- created_at

tenant_device_actions:
- id
- tenant_device_id
- action (reboot/reset/update_firmware/change_wifi/change_pppoe)
- payload (JSON)
- status (pending/sent/completed/failed)
- created_at
- updated_at

--------------------------------------------------------------------
8. VUE FRONTEND INTEGRATION
--------------------------------------------------------------------
Create Vue pages:

Pages/Tenants/Devices/Index.vue
- List all devices linked to current tenant
- Filter by online/offline/model
- Show basic info: model, IP, uptime, signal, firmware

Pages/Tenants/Devices/View.vue
- Full device dashboard
- CPU, RAM, uptime
- Traffic stats
- WiFi config controls
- PPPoE config controls
- Diagnostics
- Actions (reboot/reset)

Pages/Tenants/Devices/Actions/ChangeWifi.vue
Pages/Tenants/Devices/Actions/ChangePPPoE.vue
Pages/Tenants/Devices/Actions/UpdateFirmware.vue

Integrate WebSockets or polling for real-time status.

--------------------------------------------------------------------
9. ACTION QUEUE SYSTEM
--------------------------------------------------------------------
Device actions should:
- Be inserted into tenant_device_actions table
- Laravel job dispatches to GenieACS API
- GenieACS pushes the action to the device
- Device reports execution status
- Laravel updates the action status
- UI shows progress in real-time

--------------------------------------------------------------------
10. AUTO-PROVISIONING NEW ROUTERS
--------------------------------------------------------------------
When a new router first connects:
- GenieACS triggers provisioning script
- Script requests subscriber info from Laravel:
    → PPPoE username/password
    → WiFi SSID/password
    → Default settings

Laravel returns:
- Config package
- User credentials
- Device grouping info (optional)

GenieACS applies configuration automatically.

--------------------------------------------------------------------
11. TENANT-SPECIFIC ISOLATION
--------------------------------------------------------------------
Follow Stancl Tenancy rules:
- Only show devices belonging to the authenticated tenant
- Do NOT mix devices across tenants
- Actions must be tenant-specific
- Device logs must be tenant-isolated

--------------------------------------------------------------------
12. NOTIFICATIONS & LOGGING
--------------------------------------------------------------------
SMS or system notifications:
- If device goes offline >10 minutes
- If firmware update fails
- If provisioning fails

Store logs for:
- All device actions
- Provisioning events
- Status changes
- Router errors (“PPP negotiation failed”, etc.)

--------------------------------------------------------------------
13. SECURITY REQUIREMENTS
--------------------------------------------------------------------
- Use HTTPS for ACS endpoint
- Use strong ACS username/password
- Validate serial numbers before linking devices
- Multi-tenant data isolation
- Rate-limit device polling from Laravel
- Encrypt Wi-Fi and PPPoE passwords in DB

--------------------------------------------------------------------
14. TESTING PROCEDURE
--------------------------------------------------------------------
1. Add a MikroTik router
2. Enable TR-069 and point it to GenieACS
3. Verify device appears in GenieACS
4. Link device with a dummy subscriber
5. Change WiFi password from Laravel → confirm router updates
6. Change PPPoE password from Laravel → confirm connection resets
7. Trigger reboot → confirm success
8. Monitor stats → verify CPU, RAM, IP are collected
9. Perform firmware update → verify success

--------------------------------------------------------------------
15. FINAL GOAL
--------------------------------------------------------------------
Our system should allow tenants to fully manage customer routers from our dashboard, including:
- Remote configuration
- Auto-provisioning
- Monitoring
- Firmware control
- WiFi & PPPoE setup
- Diagnostics
- Logs and analytics
